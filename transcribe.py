from typing import Literal
import pathlib
import glob
from pprint import pprint
import json

import whisper


def transcribe_videos(video_directory: str, model, destination_folder: str):
    if (not pathlib.Path(video_directory).exists() 
        or not pathlib.Path(destination_folder).exists()):
        raise ValueError("video or destination folder do not exist")
    
    files = glob.glob(video_directory + "/*.mp4")
    if not files:
        raise ValueError("No mp4 files found in given directory")
    
    for file_path in files:
        file = pathlib.Path(file_path)
        print(f"transcribing {file.name}...", end="")
        try:
            transcript = model.transcribe(file_path)
        except Exception as e:
            print(e)
            raise
        else:
            print("success!")
            # print(transcript["text"])
            save_path = pathlib.Path(destination_folder) / (str(file.stem) + ".json")
            print(f"saving result to {save_path}")
            with open(save_path, 'w') as output_file:
                json.dump(transcript, output_file)
    return None


if __name__ == '__main__':
    video_folder = "./videos"
    destination_folder = "./transcriptions_en"
    pathlib.Path(destination_folder).mkdir(parents=True, exist_ok=True)
    model_name: Literal["tiny", "base", "small", "medium", "large"] = "tiny"
    model = whisper.load_model(model_name)
    transcribe_videos(video_folder, model, destination_folder)
